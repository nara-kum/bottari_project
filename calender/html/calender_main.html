<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="../css/stylesheet.css" />
    <link href='../full_calender/main.css' rel='stylesheet' />
    <script src='../full_calender/main.js'></script>

</head>

<body>
    <div class="screen">
        <div class="header">
            <div class="auto-layout-left">
                <div
                    style="width: 150px; height: 37px; background: #ddd; display: flex; align-items: center; justify-content: center;">
                    LOGO</div>
                <div class="header-menu">ìº˜ë¦°ë”</div>
                <div class="header-menu">í€ë”©</div>
                <div class="header-menu">ì´ˆëŒ€ì¥</div>
                <div class="header-menu">êµ¬ë§¤ë‚´ì—­</div>
            </div>
            <div class="auto-layout-right">
                <div class="shopping-cart-frame">ğŸ›’</div>
                <div class="header-usermenu">ì‚¬ìš©ìì´ë¦„</div>
                <span>â–¼</span>
            </div>
        </div>
        <div class="body">
            <div class="calender-form">
                <div class="calender">
                    <div id="calendar"></div>
                </div>
            </div>
            <div class="detail-form">
                <div id="select-date-box">ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”</div>
                <div class="no-detail">
                    <div style="font-size: 48px; margin: 20px 0;">ğŸ“…</div>
                    <div>
                        <div style="font-size: 20px; margin-bottom: 20px;">ë“±ë¡ëœ ê¸°ë…ì¼ì´ ì—†ì–´ìš”</div>
                        <button class="btn-add-event">ê¸°ë…ì¼ ë“±ë¡í•˜ê¸°</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            console.log('ì´ˆê¸°í™” ì™„ë£Œ');

            let lastClickTime = 0;
            let lastClickedDate = null;
            let selectedDate = null;

            // ì•„ì´ì½˜ ë§¤í•‘
            const iconMapping = {
                'birthday': 'ğŸ‚',
                'wedding': 'ğŸ’',
                'thanks': 'â¤ï¸',
                'baby': 'ğŸ‘¶',
                'event': 'ğŸ¥‚',
                'celebrate': 'ğŸ‰'
            };

            // RRule ë°˜ë³µ ì˜µì…˜ì„ RRule ê°ì²´ë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜
            function createRRule(repeatType, startDate) {
                const start = new Date(startDate);

                switch (repeatType) {
                    case 'every-day':
                        return new RRule({
                            freq: RRule.DAILY,
                            dtstart: start
                        });
                    case 'every-week':
                        return new RRule({
                            freq: RRule.WEEKLY,
                            dtstart: start
                        });
                    case 'every-month':
                        return new RRule({
                            freq: RRule.MONTHLY,
                            dtstart: start
                        });
                    case 'every-year':
                        return new RRule({
                            freq: RRule.YEARLY,
                            dtstart: start
                        });
                    default:
                        return null; // ë°˜ë³µ ì•ˆí•¨
                }
            }

            // ìŠ¤ì¼€ì¤„ íŒì—… ì—´ê¸°
            function openSchedulePopup(dateStr = null) {
                if (!dateStr) {
                    if (selectedDate) {
                        dateStr = selectedDate;
                    } else {
                        const today = new Date();
                        dateStr = today.getFullYear() + '-' +
                            String(today.getMonth() + 1).padStart(2, '0') + '-' +
                            String(today.getDate()).padStart(2, '0');
                    }
                }

                Swal.fire({
                    html: `
                        <div class="schedule-popup">
                            <div class="cross-container">
                                <span style="cursor: pointer; font-size: 20px;" onclick="Swal.close()">âœ•</span>
                            </div>
                            <div class="schedule-name">
                                <div class="icon-selector">
                                    <div class="selected-icon" onclick="toggleIconDropdown()">
                                        <span id="selected-icon-img">ğŸ‚</span>
                                        <span class="dropdown-arrow">â–¼</span>
                                    </div>
                                    <div class="icon-dropdown" id="icon-dropdown" style="display: none;">
                                        <div class="icon-option" data-value="birthday" onclick="selectIcon('birthday', 'ğŸ‚')">
                                            <span>ğŸ‚</span>
                                        </div>
                                        <div class="icon-option" data-value="wedding" onclick="selectIcon('wedding', 'ğŸ’')">
                                            <span>ğŸ’</span>
                                        </div>
                                        <div class="icon-option" data-value="thanks" onclick="selectIcon('thanks', 'â¤ï¸')">
                                            <span>â¤ï¸</span>
                                        </div>
                                        <div class="icon-option" data-value="baby" onclick="selectIcon('baby', 'ğŸ‘¶')">
                                            <span>ğŸ‘¶</span>
                                        </div>
                                        <div class="icon-option" data-value="event" onclick="selectIcon('event', 'ğŸ¥‚')">
                                            <span>ğŸ¥‚</span>
                                        </div>
                                        <div class="icon-option" data-value="celebrate" onclick="selectIcon('celebrate', 'ğŸ‰')">
                                            <span>ğŸ‰</span>
                                        </div>
                                    </div>
                                    <input type="hidden" id="selected-icon-value" value="birthday">
                                </div>
                                <div class="textbox">
                                    <input name="event_name" type="text" placeholder="ì¼ì • ì œëª©" />
                                </div>
                            </div>
                            <div class="repeat-option">
                                <span class="box-icon">ğŸ”„</span>
                                <select name="repeat" class="custom-select">
                                    <option value="no-repeat">ë°˜ë³µ ì•ˆí•¨</option>
                                    <option value="every-day">ë§¤ì¼</option>
                                    <option value="every-week">ë§¤ì£¼</option>
                                    <option value="every-month">ë§¤ì›”</option>
                                    <option value="every-year">ë§¤ë…„</option>
                                </select>
                            </div>
                            <div class="explanation-group">
                                <span class="box-icon">ğŸ’¬</span>
                                <textarea name="explanation" class="explanation-textarea" placeholder="ì„¤ëª… ì¶”ê°€"></textarea>
                            </div>
                            <button class="btn-save" onclick="saveEvent('${dateStr}')">ì €ì¥</button>
                        </div>
                    `,
                    showCancelButton: false,
                    showConfirmButton: false,
                    showClass: { popup: '' },
                    hideClass: { popup: '' }
                });
            }

            // ì•„ì´ì½˜ ë“œë¡­ë‹¤ìš´ í† ê¸€
            window.toggleIconDropdown = function () {
                const dropdown = document.getElementById('icon-dropdown');
                dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
            };

            // ì•„ì´ì½˜ ì„ íƒ
            window.selectIcon = function (value, icon) {
                document.getElementById('selected-icon-img').textContent = icon;
                document.getElementById('selected-icon-value').value = value;
                document.getElementById('icon-dropdown').style.display = 'none';
            };

            // ì´ë²¤íŠ¸ ì €ì¥
            window.saveEvent = function (dateStr) {
                const title = document.querySelector("input[name='event_name']").value;
                const repeat = document.querySelector("select[name='repeat']").value;
                const explanation = document.querySelector("textarea[name='explanation']").value;
                const selectedIcon = document.getElementById('selected-icon-value').value;

                if (!title) {
                    alert('ì¼ì • ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }

                const eventData = {
                    title: title,
                    allDay: true,
                    extendedProps: {
                        icon: selectedIcon,
                        repeat: repeat,
                        explanation: explanation
                    }
                };

                // ë°˜ë³µ ì„¤ì •ì´ ìˆëŠ” ê²½ìš° RRule ì¶”ê°€
                if (repeat !== 'no-repeat') {
                    const rrule = createRRule(repeat, dateStr);
                    if (rrule) {
                        eventData.rrule = rrule.toString();
                        console.log('RRule ìƒì„±ë¨:', rrule.toString());
                    }
                } else {
                    // ë°˜ë³µ ì—†ëŠ” ê²½ìš° ë‹¨ì¼ ì´ë²¤íŠ¸
                    eventData.start = dateStr;
                }

                calendar.addEvent(eventData);
                console.log('ì´ë²¤íŠ¸ ì¶”ê°€ë¨:', eventData);
                Swal.close();
            };

            // ìº˜ë¦°ë” ì´ˆê¸°í™”
            var calendarEl = document.getElementById('calendar');
            var calendar = new FullCalendar.Calendar(calendarEl, {
                plugins: ['rrule'], // RRule í”ŒëŸ¬ê·¸ì¸ í™œì„±í™”
                headerToolbar: {
                    left: 'prevYear,prev today',
                    center: 'title',
                    right: 'next,nextYear'
                },
                titleFormat: {
                    year: 'numeric',
                    month: 'short'
                },

                // ì´ë²¤íŠ¸ ë Œë”ë§ ì»¤ìŠ¤í„°ë§ˆì´ì§•
                eventContent: function (arg) {
                    const icon = arg.event.extendedProps.icon;
                    const iconDisplay = iconMapping[icon] || 'ğŸ‚';

                    return {
                        html: `
                            <div class="custom-event">
                                <span class="event-icon">${iconDisplay}</span>
                                <span class="event-title">${arg.event.title}</span>
                            </div>
                        `
                    };
                },

                // ì›” ë³€ê²½ ì‹œ ì œëª© ì»¤ìŠ¤í„°ë§ˆì´ì§•
                datesSet: function (info) {
                    var currentDate = info.view.currentStart;
                    var year = currentDate.getFullYear();
                    var month = String(currentDate.getMonth() + 1).padStart(2, '0');

                    setTimeout(function () {
                        var titleElement = document.querySelector('.fc-toolbar-title');
                        if (titleElement) {
                            titleElement.style.display = 'none';
                        }

                        var customTitle = document.querySelector('.custom-calendar-title');
                        if (!customTitle) {
                            customTitle = document.createElement('div');
                            customTitle.className = 'custom-calendar-title';
                            var centerElement = document.querySelector('.fc-toolbar-chunk:nth-child(2)');
                            if (centerElement) {
                                centerElement.appendChild(customTitle);
                            }
                        }

                        customTitle.textContent = year + '-' + month;
                    }, 50);
                },

                navLinks: false,
                editable: true,

                // ë‚ ì§œ í´ë¦­ ì´ë²¤íŠ¸
                dateClick: function (info) {
                    console.log("ë‚ ì§œ í´ë¦­ë¨:", info.dateStr);

                    const date = new Date(info.dateStr);
                    const month = date.getMonth() + 1;
                    const day = date.getDate();
                    const year = date.getFullYear();

                    selectedDate = info.dateStr;
                    document.getElementById('select-date-box').textContent = `${year}-${month}-${day}`;

                    // ì´ì „ ì„ íƒ í•´ì œ
                    document.querySelectorAll('.fc-daygrid-day').forEach(function (day) {
                        day.classList.remove('selected-date');
                    });
                    // ìƒˆë¡œìš´ ì„ íƒ
                    info.dayEl.classList.add('selected-date');

                    // ë”ë¸”í´ë¦­ ê°ì§€
                    const currentTime = new Date().getTime();
                    const clickedDate = info.dateStr;

                    if (lastClickedDate === clickedDate && (currentTime - lastClickTime) < 400) {
                        openSchedulePopup(info.dateStr);
                    }

                    lastClickTime = currentTime;
                    lastClickedDate = clickedDate;
                },

                // ì´ë²¤íŠ¸ í´ë¦­ ì‹œ ì‚­ì œ í™•ì¸
                eventClick: function (arg) {
                    const isRecurring = arg.event.extendedProps.repeat !== 'no-repeat' && arg.event.extendedProps.repeat;

                    let deleteMessage = "ì´ ì´ë²¤íŠ¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?";
                    if (isRecurring) {
                        deleteMessage = "ë°˜ë³µ ì´ë²¤íŠ¸ì…ë‹ˆë‹¤. ëª¨ë“  ë°˜ë³µì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?";
                    }

                    Swal.fire({
                        text: deleteMessage,
                        icon: "warning",
                        showCancelButton: true,
                        confirmButtonText: "ì‚­ì œ",
                        cancelButtonText: "ì·¨ì†Œ"
                    }).then(function (result) {
                        if (result.value) {
                            arg.event.remove();
                        }
                    });
                },

                dayMaxEvents: true,
                height: 600,
                aspectRatio: 1.35,

                // ìƒ˜í”Œ ì´ë²¤íŠ¸ (RRule ì‚¬ìš© ì˜ˆì‹œ)
                events: [
                    {
                        title: 'ìƒì¼ (ë§¤ë…„ ë°˜ë³µ)',
                        rrule: {
                            freq: 'yearly',
                            dtstart: '2024-01-15'
                        },
                        extendedProps: {
                            icon: 'birthday',
                            repeat: 'every-year',
                            explanation: 'ìƒì¼ ì¶•í•˜!'
                        }
                    },
                    {
                        title: 'ì£¼ê°„ ë¯¸íŒ…',
                        rrule: {
                            freq: 'weekly',
                            dtstart: '2024-12-16',
                            byweekday: [1] // ì›”ìš”ì¼
                        },
                        extendedProps: {
                            icon: 'event',
                            repeat: 'every-week',
                            explanation: 'ì£¼ê°„ íŒ€ ë¯¸íŒ…'
                        }
                    }
                ]
            });

            calendar.render();

            // ê¸°ë…ì¼ ìƒì„±ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
            document.querySelector('.btn-add-event').addEventListener('click', function () {
                console.log('ê¸°ë…ì¼ ìƒì„±ë²„íŠ¼ í´ë¦­ ê°ì§€');
                openSchedulePopup();
            });

            // ì™¸ë¶€ í´ë¦­ ì‹œ ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
            document.addEventListener('click', function (event) {
                const iconSelector = document.querySelector('.icon-selector');
                const dropdown = document.getElementById('icon-dropdown');
                if (dropdown && iconSelector && !iconSelector.contains(event.target)) {
                    dropdown.style.display = 'none';
                }
            });
        });
    </script>
</body>

</html>