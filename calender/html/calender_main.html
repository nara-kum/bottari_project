<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="../css/stylesheet.css" />
    <link href='../full_calender/main.css' rel='stylesheet' />
    <script src='../full_calender/main.js'></script>

</head>

<body>
    <div class="screen">
        <div class="header">
            <div class="auto-layout-left">
                <div
                    style="width: 150px; height: 37px; background: #ddd; display: flex; align-items: center; justify-content: center;">
                    LOGO</div>
                <div class="header-menu">캘린더</div>
                <div class="header-menu">펀딩</div>
                <div class="header-menu">초대장</div>
                <div class="header-menu">구매내역</div>
            </div>
            <div class="auto-layout-right">
                <div class="shopping-cart-frame">🛒</div>
                <div class="header-usermenu">사용자이름</div>
                <span>▼</span>
            </div>
        </div>
        <div class="body">
            <div class="calender-form">
                <div class="calender">
                    <div id="calendar"></div>
                </div>
            </div>
            <div class="detail-form">
                <div id="select-date-box">날짜를 선택하세요</div>
                <div class="no-detail">
                    <div style="font-size: 48px; margin: 20px 0;">📅</div>
                    <div>
                        <div style="font-size: 20px; margin-bottom: 20px;">등록된 기념일이 없어요</div>
                        <button class="btn-add-event">기념일 등록하기</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            console.log('초기화 완료');

            let lastClickTime = 0;
            let lastClickedDate = null;
            let selectedDate = null;

            // 아이콘 매핑
            const iconMapping = {
                'birthday': '🎂',
                'wedding': '💍',
                'thanks': '❤️',
                'baby': '👶',
                'event': '🥂',
                'celebrate': '🎉'
            };

            // RRule 반복 옵션을 RRule 객체로 변환하는 함수
            function createRRule(repeatType, startDate) {
                const start = new Date(startDate);

                switch (repeatType) {
                    case 'every-day':
                        return new RRule({
                            freq: RRule.DAILY,
                            dtstart: start
                        });
                    case 'every-week':
                        return new RRule({
                            freq: RRule.WEEKLY,
                            dtstart: start
                        });
                    case 'every-month':
                        return new RRule({
                            freq: RRule.MONTHLY,
                            dtstart: start
                        });
                    case 'every-year':
                        return new RRule({
                            freq: RRule.YEARLY,
                            dtstart: start
                        });
                    default:
                        return null; // 반복 안함
                }
            }

            // 스케줄 팝업 열기
            function openSchedulePopup(dateStr = null) {
                if (!dateStr) {
                    if (selectedDate) {
                        dateStr = selectedDate;
                    } else {
                        const today = new Date();
                        dateStr = today.getFullYear() + '-' +
                            String(today.getMonth() + 1).padStart(2, '0') + '-' +
                            String(today.getDate()).padStart(2, '0');
                    }
                }

                Swal.fire({
                    html: `
                        <div class="schedule-popup">
                            <div class="cross-container">
                                <span style="cursor: pointer; font-size: 20px;" onclick="Swal.close()">✕</span>
                            </div>
                            <div class="schedule-name">
                                <div class="icon-selector">
                                    <div class="selected-icon" onclick="toggleIconDropdown()">
                                        <span id="selected-icon-img">🎂</span>
                                        <span class="dropdown-arrow">▼</span>
                                    </div>
                                    <div class="icon-dropdown" id="icon-dropdown" style="display: none;">
                                        <div class="icon-option" data-value="birthday" onclick="selectIcon('birthday', '🎂')">
                                            <span>🎂</span>
                                        </div>
                                        <div class="icon-option" data-value="wedding" onclick="selectIcon('wedding', '💍')">
                                            <span>💍</span>
                                        </div>
                                        <div class="icon-option" data-value="thanks" onclick="selectIcon('thanks', '❤️')">
                                            <span>❤️</span>
                                        </div>
                                        <div class="icon-option" data-value="baby" onclick="selectIcon('baby', '👶')">
                                            <span>👶</span>
                                        </div>
                                        <div class="icon-option" data-value="event" onclick="selectIcon('event', '🥂')">
                                            <span>🥂</span>
                                        </div>
                                        <div class="icon-option" data-value="celebrate" onclick="selectIcon('celebrate', '🎉')">
                                            <span>🎉</span>
                                        </div>
                                    </div>
                                    <input type="hidden" id="selected-icon-value" value="birthday">
                                </div>
                                <div class="textbox">
                                    <input name="event_name" type="text" placeholder="일정 제목" />
                                </div>
                            </div>
                            <div class="repeat-option">
                                <span class="box-icon">🔄</span>
                                <select name="repeat" class="custom-select">
                                    <option value="no-repeat">반복 안함</option>
                                    <option value="every-day">매일</option>
                                    <option value="every-week">매주</option>
                                    <option value="every-month">매월</option>
                                    <option value="every-year">매년</option>
                                </select>
                            </div>
                            <div class="explanation-group">
                                <span class="box-icon">💬</span>
                                <textarea name="explanation" class="explanation-textarea" placeholder="설명 추가"></textarea>
                            </div>
                            <button class="btn-save" onclick="saveEvent('${dateStr}')">저장</button>
                        </div>
                    `,
                    showCancelButton: false,
                    showConfirmButton: false,
                    showClass: { popup: '' },
                    hideClass: { popup: '' }
                });
            }

            // 아이콘 드롭다운 토글
            window.toggleIconDropdown = function () {
                const dropdown = document.getElementById('icon-dropdown');
                dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
            };

            // 아이콘 선택
            window.selectIcon = function (value, icon) {
                document.getElementById('selected-icon-img').textContent = icon;
                document.getElementById('selected-icon-value').value = value;
                document.getElementById('icon-dropdown').style.display = 'none';
            };

            // 이벤트 저장
            window.saveEvent = function (dateStr) {
                const title = document.querySelector("input[name='event_name']").value;
                const repeat = document.querySelector("select[name='repeat']").value;
                const explanation = document.querySelector("textarea[name='explanation']").value;
                const selectedIcon = document.getElementById('selected-icon-value').value;

                if (!title) {
                    alert('일정 제목을 입력해주세요.');
                    return;
                }

                const eventData = {
                    title: title,
                    allDay: true,
                    extendedProps: {
                        icon: selectedIcon,
                        repeat: repeat,
                        explanation: explanation
                    }
                };

                // 반복 설정이 있는 경우 RRule 추가
                if (repeat !== 'no-repeat') {
                    const rrule = createRRule(repeat, dateStr);
                    if (rrule) {
                        eventData.rrule = rrule.toString();
                        console.log('RRule 생성됨:', rrule.toString());
                    }
                } else {
                    // 반복 없는 경우 단일 이벤트
                    eventData.start = dateStr;
                }

                calendar.addEvent(eventData);
                console.log('이벤트 추가됨:', eventData);
                Swal.close();
            };

            // 캘린더 초기화
            var calendarEl = document.getElementById('calendar');
            var calendar = new FullCalendar.Calendar(calendarEl, {
                plugins: ['rrule'], // RRule 플러그인 활성화
                headerToolbar: {
                    left: 'prevYear,prev today',
                    center: 'title',
                    right: 'next,nextYear'
                },
                titleFormat: {
                    year: 'numeric',
                    month: 'short'
                },

                // 이벤트 렌더링 커스터마이징
                eventContent: function (arg) {
                    const icon = arg.event.extendedProps.icon;
                    const iconDisplay = iconMapping[icon] || '🎂';

                    return {
                        html: `
                            <div class="custom-event">
                                <span class="event-icon">${iconDisplay}</span>
                                <span class="event-title">${arg.event.title}</span>
                            </div>
                        `
                    };
                },

                // 월 변경 시 제목 커스터마이징
                datesSet: function (info) {
                    var currentDate = info.view.currentStart;
                    var year = currentDate.getFullYear();
                    var month = String(currentDate.getMonth() + 1).padStart(2, '0');

                    setTimeout(function () {
                        var titleElement = document.querySelector('.fc-toolbar-title');
                        if (titleElement) {
                            titleElement.style.display = 'none';
                        }

                        var customTitle = document.querySelector('.custom-calendar-title');
                        if (!customTitle) {
                            customTitle = document.createElement('div');
                            customTitle.className = 'custom-calendar-title';
                            var centerElement = document.querySelector('.fc-toolbar-chunk:nth-child(2)');
                            if (centerElement) {
                                centerElement.appendChild(customTitle);
                            }
                        }

                        customTitle.textContent = year + '-' + month;
                    }, 50);
                },

                navLinks: false,
                editable: true,

                // 날짜 클릭 이벤트
                dateClick: function (info) {
                    console.log("날짜 클릭됨:", info.dateStr);

                    const date = new Date(info.dateStr);
                    const month = date.getMonth() + 1;
                    const day = date.getDate();
                    const year = date.getFullYear();

                    selectedDate = info.dateStr;
                    document.getElementById('select-date-box').textContent = `${year}-${month}-${day}`;

                    // 이전 선택 해제
                    document.querySelectorAll('.fc-daygrid-day').forEach(function (day) {
                        day.classList.remove('selected-date');
                    });
                    // 새로운 선택
                    info.dayEl.classList.add('selected-date');

                    // 더블클릭 감지
                    const currentTime = new Date().getTime();
                    const clickedDate = info.dateStr;

                    if (lastClickedDate === clickedDate && (currentTime - lastClickTime) < 400) {
                        openSchedulePopup(info.dateStr);
                    }

                    lastClickTime = currentTime;
                    lastClickedDate = clickedDate;
                },

                // 이벤트 클릭 시 삭제 확인
                eventClick: function (arg) {
                    const isRecurring = arg.event.extendedProps.repeat !== 'no-repeat' && arg.event.extendedProps.repeat;

                    let deleteMessage = "이 이벤트를 삭제하시겠습니까?";
                    if (isRecurring) {
                        deleteMessage = "반복 이벤트입니다. 모든 반복을 삭제하시겠습니까?";
                    }

                    Swal.fire({
                        text: deleteMessage,
                        icon: "warning",
                        showCancelButton: true,
                        confirmButtonText: "삭제",
                        cancelButtonText: "취소"
                    }).then(function (result) {
                        if (result.value) {
                            arg.event.remove();
                        }
                    });
                },

                dayMaxEvents: true,
                height: 600,
                aspectRatio: 1.35,

                // 샘플 이벤트 (RRule 사용 예시)
                events: [
                    {
                        title: '생일 (매년 반복)',
                        rrule: {
                            freq: 'yearly',
                            dtstart: '2024-01-15'
                        },
                        extendedProps: {
                            icon: 'birthday',
                            repeat: 'every-year',
                            explanation: '생일 축하!'
                        }
                    },
                    {
                        title: '주간 미팅',
                        rrule: {
                            freq: 'weekly',
                            dtstart: '2024-12-16',
                            byweekday: [1] // 월요일
                        },
                        extendedProps: {
                            icon: 'event',
                            repeat: 'every-week',
                            explanation: '주간 팀 미팅'
                        }
                    }
                ]
            });

            calendar.render();

            // 기념일 생성버튼 클릭 이벤트
            document.querySelector('.btn-add-event').addEventListener('click', function () {
                console.log('기념일 생성버튼 클릭 감지');
                openSchedulePopup();
            });

            // 외부 클릭 시 드롭다운 닫기
            document.addEventListener('click', function (event) {
                const iconSelector = document.querySelector('.icon-selector');
                const dropdown = document.getElementById('icon-dropdown');
                if (dropdown && iconSelector && !iconSelector.contains(event.target)) {
                    dropdown.style.display = 'none';
                }
            });
        });
    </script>
</body>

</html>